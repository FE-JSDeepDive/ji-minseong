# Ch-23 실행 컨텍스트

---

## 역할
- 실행 컨텍스트는 자바스크립트 동작원리의 핵심 개념
- 다음의 역할을 수행
  1. 전역 코드 평가
  2. 전역 코드 실행
  3. 함수 코드 평가
  4. 함수 코드 실행
  
- 실행 컨텍스트는 소스코드를 실행하는데 필요한 환경 제공, 코드 실행 결과를 실제로 관리하는 영역
- 식별자 등록 -> 관리하는 스코프와 코드 실행순서 관리를 구현한 내부 매커니즘

---

## 스택
```javascript
  const x = 1;

  function foo (){
    const y = 2;

    function bar (){
      const z = 3;
      console.log(x+y+z);
    }
    bar();
  }
  foo();
```

1. 전역 코드 평가
  - 전역 실행 컨텍스트 생성
  - 실행 컨텍스트 스택에 푸쉬
  - 전역 변수 x와 전역 함수 foo는 전역 실행 컨텍스트에 등록
2. 전역 코드 실행
  - 전역 코드가 실행
  - 전역 변수 x할당, foo 호출
3. foo() 함수 코드 평가
  - 코드 제어권 foo 함수 내부로 이동
  - foo 함수 내부 코드 평가
  - foo 함수 실행 컨텍스트 생성
  - 실행 컨텍스트 스택에 푸쉬
  - foo함수 지역 변수 y와 중첩 함수 bar가 foo함수 실행 컨텍스트에 등록
4. foo() 함수 코드 실행
  - foo 함수 코드 실행
  - 지역 변수 y에 값이 할당
  - 중첩 함수 bar 호출
5. bar() 함수 코드 평가
  - 코드 제어권 bar 함수 내부로 이동
  - bar 함수 내부 코드 평가
  - bar 함수 실행 컨텍스트 생성
  - 실행 컨텍스트 스택에 푸쉬
  - 지역변수 z가 bar 실행 컨텍스트에 등록
6. bar() 함수 코드 실행
  - bar 함수 코드 실행
  - 지역 변수 z에 값이 할당
  - console.log 메서드를 호출
  - bar 함수 종료
7. foo() 함수 코드로 복귀
  - 코드 제어권 다시 foo 함수로 이동
  - bar함수 실행 컨텍스트 팝해서 제거
  - foo 함수 종료
8. 전역 코드로 복귀
  - 코드 제어권 다시 전역 코드로 이동
  - foo함수 실행 컨텍스트 팝해서 제거
  - 전역 실행 컨텍스트도 실행 컨텍스트 스택에서 팝해서제거

**이처럼 실행 컨텍스트는 코드의 실행 순서를 관리**

---

## 렉시컬 환경
- 실행 컨텍스트 : 실행 순서 관리
- 렉시컬 환경 : 스코프와 식별자 관리
  - (참고) 렉시컬 : 사전의,어희의 의미 

---

## 실행 컨텍스트 생성과 식별자 검색 과정
1. 전역 코드 평가
  1. 전역 실행 컨텍스트 생성 
  2. 전역 렉시컬 환경 생성
    - 전역 환경 레코드 생성
    - this 바인딩
  -  **(중요)** var 키워드로 선언된 변수는 코드 실행 단에서 변수 선언문 이전에도 참조할 수 있다.(현시점은 코드 평가 단계)
    - 변수 선언문 이전에 참조한 값은 언제나 **undefined** -> 호이스팅이발생하는 원리.
    - 함수 선언문으로 정의한 함수가 평가되면
      - 함수 이름과 동일한 이름의 식별자를 객체 호나경 레코드에 바인딩된 **BindingObject**를 통해 전역 객체에 키로 등록하고 생성된 함수 객체를 즉시 할당
      - 이것이 함수 호이스팅, 변수 호이스팅 차이  

2. 전역 코드 실행
  1. 식별자 결정을 위해 식별자 검색 -> 실행 중인 실행 컨텍스트에서 식별자검색
    - 렉시컬 환경에서 식별자를 검색할 수 없으면, 외부 렉시컬 환경에 대한 참조가 가리키는 렉시컬 환경 즉, 상위 스코프로 이동
      - 스코프 체인 동작 원리   

3. 함수 코드 평가 1
  1. 함수 실행 컨텍스트 생성
  2. 함수 렉시컬 환경 생성
    - 함수환경 코드 생성
    - this 바인딩
    - 외부 렉시컬 환경에 대한 참조 결정

4. 함수 코드 실행 1
  1. 식별자 결정을 위해 식별자 검색 

5. 함수 코드 평가 2
  - 위와 동일
6. 함수 코드 실행 2
  - 위와 동일
7. 순차적 종료

---

## 실행 컨텍스트와 블록 레벨 스코프
```javascript
  let x = 1;

  if(true){
    let x = 10;
    console.log(x); // 10  
  }

  console.log(1); // 1
```
- if문의 코드 블록 실행
  - if문의 코드 블록을 위한 블록 레벨 스코프를 생성해야 한다.
    - 선언적 환경 레코드를 갖는 렉시컬 환경을 새로 생성해서
      - 기존의 전역 렉시컬 환경을 교체한다.
      - 이때 새롭게 생성된 렉시컬 환경의 **외부 렉시컬 환경에 대한 참조는 if문이 실행되기 이전의 전역 렉시컬 환경을 가리킨다.**
