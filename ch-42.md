# Ch-42 비동기 프로그래밍


---

## 실행 컨텍스트와 자바스크립트의 특징
- 앞서 배웠듯이 자바스크립트는 싱글 스레드 기반의 동기적 프로그래밍 언어
- 즉, 한 번에 하나의 작업만 수행 가능
- 자바스크립트 엔진은 실행 컨텍스트 스택을 사용해 현재 실행 중인 코드의 상태를 관리
- 실행 컨텍스트 스택은 현재 실행 중인 실행 컨텍스트를 추적하는 자료 구조
- 새로운 실행 컨텍스트가 생성되면 스택에 푸시되고, 실행이 완료되면 스택에서 팝됨
- 자바스크립트는 싱글 스레드 기반이기 때문에, 한 번에 하나의 실행 컨텍스트만 활성화될 수 있음
- 따라서, 긴 작업이 실행 중일 때는 다른 작업이 대기해야 하며, 이로 인해 비동기 프로그래밍이 필요하게 됨

ex) sleep 함수와 setTimeout 함수 비교
```javascript
// sleep 함수 (동기적)
function sleep(milliseconds) {
  const start = Date.now();
  while (Date.now() - start < milliseconds) {
    // 아무 작업도 하지 않음
  }
}
```
```javascript
// setTimeout 함수 (비동기적)
function asyncSleep(milliseconds) {
  return new Promise(resolve => {
    setTimeout(resolve, milliseconds);
  });
}
```

## 동기와 비동기
- 동기(Synchronous)
  - 작업이 순차적으로 실행되는 방식
  - 이전 작업이 완료되어야 다음 작업이 시작됨
  - ex) 함수 호출, 변수 할당 등
- 비동기(Asynchronous)
  - 작업이 동시에 실행되는 방식
  - 이전 작업이 완료되지 않아도 다음 작업이 시작될 수 있음
  - ex) 네트워크 요청, 타이머 등
- 비동기 함수는 전통적으로 콜백 함수를 사용하여 작업 완료 후 실행할 코드를 지정 -> 콜백 지옥 문제 발생 가능
- **ES6부터는 `Promise` 객체를 사용하여 비동기 작업을 보다 쉽게 관리 가능**
- **ES8부터는 `async`/`await` 문법을 도입하여 비동기 코드를 동기 코드처럼 작성 가능**

## 이벤트 루프와 태스크 큐
### 콜스택
- 자바스크립트 엔진이 실행 컨텍스트를 관리하는 자료 구조
- 함수가 호출될 때마다 새로운 실행 컨텍스트가 생성되어 콜스택에 푸시되고, 함수 실행이 완료되면 팝됨
- 콜스택은 LIFO(Last In, First Out) 구조
### 힙
- 동적 메모리 할당을 관리하는 영역
- 객체, 배열 등 참조 타입의 데이터가 저장
### 태스크 큐
- 비동기 작업의 콜백 함수가 대기하는 큐
- 비동기 작업이 완료되면 해당 콜백 함수가 태스크 큐에 추가
- 이벤트 루프가 콜스택이 비어 있는지 확인하고, 비어 있으면 태스크 큐에서 콜백 함수를 꺼내 콜스택으로 이동시켜 실행

### 이벤트 루프
- 자바스크립트의 비동기 처리를 담당하는 메커니즘
- 실행 컨텍스트 스택과 태스크 큐를 관리
- **만약, 콜 스택이 비어있고, 태스크 큐에 대기 중인 콜백 함수가 있다면, 이벤트 루프는 태스크 큐에서 콜백 함수를 꺼내(FIFO) 콜 스택으로 이동시켜 실행한다.**

### 매커니즘 예시
```javascript
function start() {
  console.log('Start');
}

function end() {
  console.log('End');
}

setTimeout(() => {start()}, 0);
end();

```
1. 전역 코드 평가 -> 전역 실행 컨텍스트가 생성되어 콜스택에 푸시됨
2. 전역 코드 실행 -> `setTimeout` 함수 호출 -> setTimeout 함수의 함수 실행 컨텍스트가 콜스택에 푸시됨, Web API인 타이머 함수도 함수 실행 컨텍스트를 생성
3. setTimeout 함수 실행 완료 -> 함수 실행 컨텍스트가 콜스택에서 팝됨 
4. 브라우저, 자바스크립트 엔진 병행 처리 시작
   4-1. 브라우저는 4ms(실제로는 4ms 이히이면, 즉 0ms이라면 최소 지연 시간 4ms) 후에 콜백 함수를 태스크 큐에 추가 및 대기 (이처럼 정확한 지연 시간 보장은 불가능)
   4-2. 자바스크립트 엔진은 콜스택이 비어 있는지 확인 -> 콜스택이 비어 있지 않음 end() 함수 실행 -> 함수 실행 컨텍스트가 콜스택에 푸시됨 -> 'End' 출력 -> 함수 실행 컨텍스트가 콜스택에서 팝됨, 4ms 경과 했다면 start 함수는 아직 태스크 큐에서 대기중
5. 전역 코드 실행 종료 -> 전역 실행 컨텍스트가 콜스택에서 팝 -> 콜스택 비어 있음
6. 이벤트 루프가 콜스택이 비어 있는지 확인 -> 콜스택이 비어 있음 -> 태스크 큐에서 start 함수의 콜백 함수를 꺼내 콜스택으로 이동시켜 실행 -> 함수 실행 컨텍스트가 콜스택에 푸시됨 -> 'Start' 출력 -> 함수 실행 컨텍스트가 콜스택에서 팝됨

**(중요) 자바스크립트 엔진은 싱글 스레드지만, 브라우저는 멀티 스레드로 동작한다. 따라서 비동기가 가능하다.**